<!DOCTYPE html>
<html>
    <head>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <style type="text/css">
            div.paleBlueRows {
                font-family: "Courier New", Courier, monospace;
                border: 1px solid #FFFFFF;
                width: 100%;
                text-align: left;
            }
            .divTable.paleBlueRows .divTableCell, .divTable.paleBlueRows .divTableHead {
                border: 1px solid #FFFFFF;
                padding: 3px 2px;
            }
            .divTable.paleBlueRows .divTableBody .divTableCell {
                font-size: 17px;
            }
            .divTable.paleBlueRows .divTableRow:nth-child(even) {
                background: #D0E4F5;
            }
            .divTable.paleBlueRows .divTableHeading {
                background: #0B6FA4;
                border-bottom: 5px solid #FFFFFF;
            }
            .divTable.paleBlueRows .divTableHeading .divTableHead {
                font-size: 19px;
                font-weight: bold;
                color: #FFFFFF;
                text-align: center;
                border-left: 2px solid #FFFFFF;
            }
            .divTable.paleBlueRows .divTableHeading .divTableHead:first-child {
                border-left: none;
            }

            .paleBlueRows .tableFootStyle {
                font-size: 14px;
            }
            /* DivTable.com */
            .divTable{ display: table; }
            .divTableRow { display: table-row; }
            .divTableHeading { display: table-header-group;}
            .divTableCell, .divTableHead { display: table-cell;}
            .divTableHeading { display: table-header-group;}
            .divTableFoot { display: table-footer-group;}
            .divTableBody { display: table-row-group;}
        </style>
        <title> Overview </title>
    </head>
    <body>
        <h1>Record</h1>
        <button onclick="onAddClick()"> Add </button>
        <div class="divTable paleBlueRows" id="root">
            <div class="divTableHeading">
                <div class="divTableRow">
                    <div class="divTableHead">股票代號</div>
                    <div class="divTableHead">股票名稱</div>
                    <div class="divTableHead">最新收盤價</div>
                    <div class="divTableHead">昂貴價</div>
                    <div class="divTableHead">合理價</div>
                    <div class="divTableHead">便宜價</div>
                </div>
            </div>
            {% if dataset is not None %}
                {% for stock_id, data in dataset.items %}

                    <div class="divTableBody">
                        {{ csrf_input }}
                        <input class="c_init" type="hidden" name="s_{{ stock_id }}" value="{{data.status}}" task="{{data.task_id}}" />
                        <div class="divTableRow">
                            <div class="divTableCell">{{ stock_id }}</div>
                            <div class="divTableCell">name</div>
                            <div class="divTableCell">0.00</div>
                            <!-- begin predict price group -->
                            <div class="divTableCell" id = "price_exp_{{ stock_id }}"> {{data.data.expen}} </div>
                            <div class="divTableCell" id = "price_res_{{ stock_id }}"> {{data.data.expen}} </div>
                            <div class="divTableCell" id = "price_chp_{{ stock_id }}"> {{data.data.cheap}} </div>   
                            
                            <!--end predict price group -->                       
                        </div>                      
                    </div>         
                {% endfor %}
            {% endif %}      
        </div>

       
        <script>
            function onAddClick() {
                var $newdiv1 = $( "<div class=\"divTableBody\">{{ csrf_input }}<input class=\"c_init\" type=\"hidden\" name=\"s_{{ stock_id }}\" value=\"{{data.status}}\" task=\"{{data.task_id}}\" /></div>" )
                $("#root").append($newdiv1);
            }

            function check_update_predict_price() {
                $("input.c_init:not([value='SUCCESS'])").each(function(index, element) {  
                    var task = $(element).attr('task');                 
                    //console.log("s name = "+element.name + " task id: " + task);                    
                    if (element.value.trim() == "PENDING" ) {
                        $.ajax(
                            {
                                url:"/stock/query/",
                                type:'POST',
                                dataType:'json',
                                data:{stock_name: element.name, task_id:task},
                                success: function (response) {
                                    //console.log("status: " + response.status + " stock_id: " + response.stock_id + " value: " + response.value);  
                                    $('input[name=s_' + response.stock_id + ']').attr("value",  response.status);
                                    if (response.status == "SUCCESS") {
                                        $('#price_exp_'+ response.stock_id).text(response.value["expen"]);   
                                        $('#price_res_'+ response.stock_id).text(response.value["reson"]);  
                                        $('#price_chp_'+ response.stock_id).text(response.value["cheap"]);  
                                    }        
                                }
                    
                            }
                        );
                    }
                });
            };
            var interval_handler;

            $(
                function() {
                    interval_handler = setInterval(check_update_predict_price, 5000);                    
                }
            );
        </script>
    </body>
</html>